<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RepuxLib example usage</title>
</head>
<body>
    <div>Version: <strong id="version"></strong></div>
    <div>Max file size: <strong><span id="file-size"></span> bytes</strong></div>

    <h3>Public key</h3>
    <textarea id="public-key" style="width:100%"></textarea>

    <h3>Private key</h3>
    <textarea id="private-key" style="width:100%"></textarea>

    <br><br><br><br>

    <table style="width:100%" border="1">
        <tr>
            <th>Seller</th>
            <th>Buyer</th>
        </tr>
        <tr>
            <td>
                <h3>Upload file:</h3>
                <input type="file" id="file-input">
                <button id="upload-file">Upload</button>
                <strong>Progress:</strong>
                <div id="upload-progress"></div>
                <strong>Result:</strong>
                <div id="upload-result"></div>
            </td>
            <td>
                <h3>Download file:</h3>
                <input id="download-file-hash" type="text" placeholder="Meta file hash">
                <textarea id="download-encrypted-symmetric-key" placeholder="Encrypted symmetric key"></textarea>
                <button id="download-file">Download</button>
                <strong>Progress:</strong>
                <div id="download-progress"></div>
                <strong>Result:</strong>
                <div id="download-result"></div>
            </td>
        </tr>
        <tr>
            <td>
                <h3>Re-encrypt file:</h3>
                <input id="reencrypt-file-hash" type="text" placeholder="Meta file hash">
                <textarea id="buyer-public-key" placeholder="Buyer public key"></textarea>
                <button id="reencrypt-file">Re-encrypt</button>
                <strong>Progress:</strong>
                <div id="reencrypt-progress"></div>
                <strong>Result:</strong>
                <div id="reencrypt-result"></div>
            </td>
        </tr>
    </table>

    <script src="../node_modules/ipfs-api/dist/index.js"></script>
    <script type="module">
        import '../build/lib/index.js';
        const Repux = RepuxLib.default;

        const repux = new Repux(new IpfsApi({
            host: 'cryptoblox.co',
            port: 5002,
            protocol: 'https'
        }));

        function downloadBlob(blobUrl, fileName) {
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            setTimeout(function () {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(blobUrl);
            }, 0);
        }

        async function init() {
            let privateKey = localStorage.getItem('privateKey');
            let publicKey = localStorage.getItem('publicKey');

            if (!publicKey) {
                const keypair = await Repux.generateAsymmetricKeyPair();
                privateKey = JSON.stringify(keypair.privateKey);
                publicKey = JSON.stringify(keypair.publicKey);
                localStorage.setItem('privateKey', privateKey);
                localStorage.setItem('publicKey', publicKey);
            }

            document.getElementById('public-key').value = publicKey;
            document.getElementById('private-key').value = privateKey;

            document.getElementById('version').innerText = Repux.getVersion();
            document.getElementById('file-size').innerText = await Repux.getMaxFileSize();
        }

        init();

        document.getElementById('upload-file').onclick = async function() {
            const symmetricKey = await Repux.generateSymmetricKey();
            const publicKey = JSON.parse(document.getElementById('public-key').value);
            const file = document.getElementById('file-input').files[0];

            const fileUploader = repux.uploadFile(symmetricKey, publicKey, file);
            fileUploader.subscribe('progress', (eventType, progress) => {
                document.getElementById('upload-progress').innerText = progress;
            });
            fileUploader.subscribe('finish', (eventType, fileHash) => {
                 document.getElementById('upload-result').innerText = 'HASH: ' + fileHash + ', KEY: ' + JSON.stringify(symmetricKey);
                 localStorage.setItem('file_' + fileHash, JSON.stringify(symmetricKey));
            });
        };

        document.getElementById('reencrypt-file').onclick = async function() {
            const buyerPublicKey = JSON.parse(document.getElementById('buyer-public-key').value);
            const privateKey = JSON.parse(document.getElementById('private-key').value);
            const fileHash = document.getElementById('reencrypt-file-hash').value;
            const symmetricKey = JSON.parse(localStorage.getItem('file_' + document.getElementById('reencrypt-file-hash').value));
            const encryptedSymmetricKey = await Repux.encryptSymmetricKey(symmetricKey, buyerPublicKey);


            const fileReencryptor= repux.reencryptFile(privateKey, buyerPublicKey, fileHash);
            fileReencryptor.subscribe('progress', (eventType, progress) => {
                document.getElementById('reencrypt-progress').innerText = progress;
            });
            fileReencryptor.subscribe('finish', (eventType, fileHash) => {
                document.getElementById('reencrypt-result').innerText = 'HASH: ' + fileHash + ', KEY: ' + encryptedSymmetricKey;
            });
        };

        document.getElementById('download-file').onclick = async function() {
            const privateKey = JSON.parse(document.getElementById('private-key').value);
            const fileHash = document.getElementById('download-file-hash').value;
            const encryptedSymmetricKey =  document.getElementById('download-encrypted-symmetric-key').value;
            const decryptedSymmetricKey = await Repux.decryptSymmetricKey(encryptedSymmetricKey, privateKey);

            const fileDownloader = repux.downloadFile(decryptedSymmetricKey, privateKey, fileHash);
            fileDownloader.subscribe('progress', (eventType, progress) => {
                document.getElementById('download-progress').innerText = progress;
            });
            fileDownloader.subscribe('finish', (eventType, file) => {
                downloadBlob(file.fileURL, file.fileName);
            });
        }
    </script>
</body>
</html>
